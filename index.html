<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyChicken - Kasir Ayam</title>
    <link rel="icon" href="AztaoTech.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .bg-custom-orange { background-color: #F97316; }
        .text-custom-orange { color: #F97316; }
        .shadow-custom-orange { box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.1), 0 4px 6px -2px rgba(249, 115, 22, 0.05); }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-amber-100 min-h-screen">

    <div class="container mx-auto px-4 py-8 max-w-lg">
        <div id="page1" class="page-content">
            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6 border-b-4 border-custom-orange">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2 animate-bounce">üêî</div>
                    <h1 class="text-3xl font-bold text-gray-800">My Chicken</h1>
                    <p class="text-gray-600 text-sm">Hitung harga ayam berdasarkan berat</p>
                </div>

                <div class="bg-orange-50 rounded-xl p-4 mb-6">
                    <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                        ‚öôÔ∏è Pengaturan Harga
                    </h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Harga per Kg</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                            <input type="number" id="hargaPerKg" value="33000" 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent">
                        </div>
                    </div>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Berat Total (Kg)</label>
                        <input type="number" id="beratTotal" step="0.1" placeholder="0.0"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent text-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Ekor</label>
                        <input type="number" id="jumlahEkor" placeholder="0"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent text-lg">
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 mb-6">
                    <h3 class="font-semibold text-gray-700 mb-3">üí∞ Total Harga</h3>
                    <div class="text-3xl font-bold text-custom-orange" id="totalHarga">Rp 0</div>
                    <div class="text-sm text-gray-600 mt-1" id="detailHarga">0 kg √ó Rp 0 = Rp 0</div>
                </div>

                <button onclick="lanjutKeHalaman2()" id="btnLanjut" disabled
                        class="w-full bg-custom-orange hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                    Lanjut ke Pembayaran ‚Üí
                </button>
            </div>
            <div class="flex justify-center mt-4">
                <button onclick="lanjutKeHutang()" class="text-sm text-custom-orange hover:underline">
                    Lihat Daftar Hutang ‚Üí
                </button>
            </div>
        </div>

        <div id="page2" class="page-content hidden">
            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6 border-b-4 border-custom-orange">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üìù</div>
                    <h1 class="text-3xl font-bold text-gray-800">Detail Pembeli</h1>
                    <p class="text-gray-600 text-sm">Lengkapi informasi pembayaran</p>
                </div>

                <div class="bg-orange-50 rounded-xl p-4 mb-6">
                    <h3 class="font-semibold text-gray-700 mb-2">üìã Ringkasan Pesanan</h3>
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between">
                            <span>Berat:</span>
                            <span id="ringkasanBerat">0 kg</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Jumlah Ekor:</span>
                            <span id="ringkasanEkor">0 ekor</span>
                        </div>
                        <div class="flex justify-between font-semibold text-custom-orange">
                            <span>Total:</span>
                            <span id="ringkasanTotal">Rp 0</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pembeli</label>
                        <input type="text" id="namaPembeli" placeholder="Masukkan nama pembeli"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent">
                    </div>

                    <div class="bg-yellow-50 rounded-xl p-4">
                        <h3 class="font-semibold text-gray-700 mb-3">üî™ Layanan Bubut</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="radio" name="bubut" value="tidak" checked
                                       class="w-4 h-4 text-custom-orange focus:ring-custom-orange">
                                <span class="ml-2 text-sm">Tidak perlu dibubut</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="bubut" value="ya"
                                       class="w-4 h-4 text-custom-orange focus:ring-custom-orange">
                                <span class="ml-2 text-sm">Ya, bubut ayam</span>
                            </label>
                        </div>
                        
                        <div id="hargaBubutContainer" class="mt-3 hidden">
                            <label class="block text-sm font-medium text-gray-600 mb-1">Harga Bubut per Ekor</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                                <input type="number" id="hargaBubut" value="3000"
                                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span>Harga Ayam:</span>
                                <span id="hargaAyamFinal">Rp 0</span>
                            </div>
                            <div class="flex justify-between text-sm" id="hargaBubutRow" style="display: none;">
                                <span>Biaya Bubut:</span>
                                <span id="biayaBubut">Rp 0</span>
                            </div>
                            <hr class="my-2">
                            <div class="flex justify-between font-bold text-lg text-custom-orange">
                                <span>Total Bayar:</span>
                                <span id="totalBayar">Rp 0</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Uang Dibayarkan</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                            <input type="number" id="uangDibayar" placeholder="0"
                                   class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-custom-orange focus:border-transparent text-lg">
                        </div>
                    </div>

                    <div class="bg-green-50 rounded-xl p-4" id="kembalianContainer" style="display: none;">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-700">üíµ Kembalian:</span>
                            <span class="text-xl font-bold text-green-600" id="kembalian">Rp 0</span>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col space-y-3 mt-4">
                    <button onclick="selesaikanTransaksi()" id="btnSelesai"
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                        Selesaikan Transaksi
                    </button>
                    <button onclick="simpanHutang()" id="btnHutang"
                            class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                        Simpan sebagai Hutang
                    </button>
                    <button onclick="kembaliKeHalaman1()"
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                        ‚Üê Kembali
                    </button>
                </div>
            </div>
        </div>

        <div id="page3" class="page-content hidden">
            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6 border-b-4 border-custom-orange">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">‚úÖ</div>
                    <h1 class="text-3xl font-bold text-gray-800">Transaksi Selesai</h1>
                    <p class="text-gray-600 text-sm">Terima kasih atas pembeliannya!</p>
                </div>

                <div class="bg-gray-50 rounded-xl p-6 mb-6 font-mono border-l-4 border-green-400" id="struk">
                    <div class="text-center">
                        <h2 class="text-lg font-bold">üêî MyChicken</h2>
                        <p class="text-xs text-gray-600">Jl. Anjah Anjah, Desa Rempek Darussalam</p>
                        <hr class="my-4 border-dashed border-gray-400">
                    </div>
                    
                    <div class="text-sm space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Nama Pembeli:</span>
                            <span id="strukNama" class="font-bold">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Tanggal:</span>
                            <span id="tanggalTransaksi" class="font-semibold text-gray-800"></span>
                        </div>
                        <hr class="my-4 border-dashed border-gray-400">
                        <div class="flex justify-between">
                            <span>Berat Ayam:</span>
                            <span id="strukBerat">0 kg</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Jumlah Ekor:</span>
                            <span><span id="strukEkor">0</span> ekor</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Harga/Kg:</span>
                            <span id="strukHargaKg">Rp 0</span>
                        </div>
                        <div class="flex justify-between font-semibold">
                            <span>Subtotal Ayam:</span>
                            <span id="strukSubtotal">Rp 0</span>
                        </div>
                        <div class="flex justify-between" id="strukBubutRow" style="display: none;">
                            <span>Biaya Bubut:</span>
                            <span id="strukBiayaBubut">Rp 0</span>
                        </div>
                    </div>
                    
                    <hr class="my-4 border-dashed border-gray-400">
                    
                    <div class="space-y-2">
                        <div class="flex justify-between items-center font-bold text-lg text-custom-orange">
                            <span>Total:</span>
                            <span id="strukTotal">Rp 0</span>
                        </div>
                        
                        <div class="flex justify-between items-center text-sm" id="strukDibayarRow">
                            <span class="text-gray-600">Uang Dibayar:</span>
                            <span id="strukDibayar">Rp 0</span>
                        </div>
                        
                        <div class="flex justify-between items-center font-semibold text-red-600" id="strukSisaHutangRow" style="display: none;">
                            <span>Sisa Hutang:</span>
                            <span id="strukSisaHutang">Rp 0</span>
                        </div>
                        
                        <div class="flex justify-between items-center font-semibold text-green-600" id="strukKembalianRow" style="display: none;">
                            <span>Kembalian:</span>
                            <span id="strukKembalian">Rp 0</span>
                        </div>
                    </div>
                    
                    <div class="text-center text-sm text-gray-500 mt-6">
                        <p>Terima kasih telah berbelanja di MyChicken!</p>
                    </div>
                </div>

                <div class="flex flex-col space-y-3 mt-4">
                    <button onclick="transaksiBaru()"
                            class="w-full bg-custom-orange hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                        üîÑ Transaksi Baru
                    </button>
                    <button onclick="downloadStruk()"
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                        ‚¨áÔ∏è Download Struk
                    </button>
                </div>
            </div>
        </div>

        <div id="page4" class="page-content hidden">
            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6 border-b-4 border-custom-orange">
                <div class="text-center mb-6">
                    <div class="text-5xl mb-2">üí∏</div>
                    <h1 class="text-3xl font-bold text-gray-800">Daftar Hutang</h1>
                    <p class="text-gray-600 text-sm" id="infoHutang"></p>
                </div>
                
                <div id="daftarHutang" class="space-y-4">
                    </div>
                
                <button onclick="kembaliKeHalaman1()"
                        class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors transform hover:scale-105">
                    ‚Üê Kembali ke Beranda
                </button>
            </div>
        </div>
    </div>

    <div id="modalBayarHutang" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Pembayaran Hutang</h2>
            <div class="mb-4">
                <p class="text-sm text-gray-600">Nama: <span id="modalNamaHutang" class="font-semibold"></span></p>
                <p class="text-sm text-gray-600">Total Hutang: <span id="modalTotalHutang" class="font-semibold text-red-600"></span></p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Pembayaran</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                    <input type="number" id="inputBayarHutang" placeholder="0"
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="tutupModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                <button onclick="prosesPembayaranHutang()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Bayar</button>
            </div>
        </div>
    </div>

    <script>
        let dataTransaksi = {};
        let db = null;
        let idHutangAktif = null;

        // Inisialisasi Database
        async function initDatabase() {
            try {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                db = new SQL.Database();
                db.run("CREATE TABLE IF NOT EXISTS utang (id INTEGER PRIMARY KEY AUTOINCREMENT, nama TEXT, berat REAL, ekor INTEGER, total REAL, tanggal TEXT);");
                console.log("Database initialized successfully.");
            } catch (err) {
                console.error("Failed to initialize database:", err);
            }
        }

        // Format rupiah
        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(angka);
        }

        // Hitung total harga di halaman 1
        function hitungTotal() {
            const hargaPerKg = parseFloat(document.getElementById('hargaPerKg').value) || 0;
            const beratTotal = parseFloat(document.getElementById('beratTotal').value) || 0;
            const jumlahEkor = parseInt(document.getElementById('jumlahEkor').value) || 0;
            
            const total = hargaPerKg * beratTotal;
            
            document.getElementById('totalHarga').textContent = formatRupiah(total);
            document.getElementById('detailHarga').textContent = 
                `${beratTotal} kg √ó ${formatRupiah(hargaPerKg)} = ${formatRupiah(total)}`;
            
            const btnLanjut = document.getElementById('btnLanjut');
            if (beratTotal > 0 && jumlahEkor > 0) {
                btnLanjut.disabled = false;
            } else {
                btnLanjut.disabled = true;
            }
        }

        // Event listeners untuk halaman 1
        document.getElementById('hargaPerKg').addEventListener('input', hitungTotal);
        document.getElementById('beratTotal').addEventListener('input', hitungTotal);
        document.getElementById('jumlahEkor').addEventListener('input', hitungTotal);

        // Lanjut ke halaman 2
        function lanjutKeHalaman2() {
            dataTransaksi.hargaPerKg = parseFloat(document.getElementById('hargaPerKg').value);
            dataTransaksi.beratTotal = parseFloat(document.getElementById('beratTotal').value);
            dataTransaksi.jumlahEkor = parseInt(document.getElementById('jumlahEkor').value);
            dataTransaksi.totalAyam = dataTransaksi.hargaPerKg * dataTransaksi.beratTotal;
            
            document.getElementById('ringkasanBerat').textContent = `${dataTransaksi.beratTotal} kg`;
            document.getElementById('ringkasanEkor').textContent = `${dataTransaksi.jumlahEkor} ekor`;
            document.getElementById('ringkasanTotal').textContent = formatRupiah(dataTransaksi.totalAyam);
            document.getElementById('hargaAyamFinal').textContent = formatRupiah(dataTransaksi.totalAyam);
            
            hitungTotalAkhir();
            
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page2').classList.remove('hidden');
        }

        // Handle radio button bubut
        document.querySelectorAll('input[name="bubut"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const hargaBubutContainer = document.getElementById('hargaBubutContainer');
                if (this.value === 'ya') {
                    hargaBubutContainer.classList.remove('hidden');
                } else {
                    hargaBubutContainer.classList.add('hidden');
                }
                hitungTotalAkhir();
            });
        });

        // Hitung total akhir di halaman 2
        function hitungTotalAkhir() {
            const perluBubut = document.querySelector('input[name="bubut"]:checked').value === 'ya';
            const hargaBubut = parseFloat(document.getElementById('hargaBubut').value) || 0;
            
            let biayaBubut = 0;
            if (perluBubut) {
                biayaBubut = hargaBubut * dataTransaksi.jumlahEkor;
                document.getElementById('hargaBubutRow').style.display = 'flex';
                document.getElementById('biayaBubut').textContent = formatRupiah(biayaBubut);
            } else {
                document.getElementById('hargaBubutRow').style.display = 'none';
            }
            
            const totalBayar = dataTransaksi.totalAyam + biayaBubut;
            document.getElementById('totalBayar').textContent = formatRupiah(totalBayar);
            
            dataTransaksi.biayaBubut = biayaBubut;
            dataTransaksi.totalBayar = totalBayar;
            dataTransaksi.perluBubut = perluBubut;
            
            hitungKembalian();
        }

        // Hitung kembalian
        function hitungKembalian() {
            const uangDibayar = parseFloat(document.getElementById('uangDibayar').value) || 0;
            const kembalian = uangDibayar - dataTransaksi.totalBayar;
            
            if (uangDibayar > 0) {
                document.getElementById('kembalianContainer').style.display = 'block';
                if (kembalian >= 0) {
                    document.getElementById('kembalian').textContent = formatRupiah(kembalian);
                    document.getElementById('kembalian').className = 'text-xl font-bold text-green-600';
                } else {
                    document.getElementById('kembalian').textContent = formatRupiah(Math.abs(kembalian)) + ' (kurang)';
                    document.getElementById('kembalian').className = 'text-xl font-bold text-red-600';
                }
            } else {
                document.getElementById('kembalianContainer').style.display = 'none';
            }
            
            dataTransaksi.uangDibayar = uangDibayar;
            dataTransaksi.kembalian = kembalian;
        }

        // Event listeners untuk halaman 2
        document.getElementById('hargaBubut').addEventListener('input', hitungTotalAkhir);
        document.getElementById('uangDibayar').addEventListener('input', hitungKembalian);

        // Kembali ke halaman 1
        function kembaliKeHalaman1() {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page1').classList.remove('hidden');
        }

        // Lanjut ke halaman hutang
        async function lanjutKeHutang() {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page4').classList.remove('hidden');
            await tampilHutang();
        }

        // Selesaikan transaksi
        function selesaikanTransaksi() {
            const namaPembeli = document.getElementById('namaPembeli').value.trim();
            const uangDibayar = parseFloat(document.getElementById('uangDibayar').value) || 0;
            const totalBayar = dataTransaksi.totalBayar;
            
            if (!namaPembeli) {
                alert('Mohon isi nama pembeli!');
                return;
            }

            dataTransaksi.namaPembeli = namaPembeli;
            dataTransaksi.uangDibayar = uangDibayar;

            if (uangDibayar < totalBayar) {
                const sisaHutang = totalBayar - uangDibayar;
                if (confirm(`Uang yang dibayarkan kurang. Apakah Anda ingin menyimpan sisa ${formatRupiah(sisaHutang)} sebagai hutang?`)) {
                    simpanHutang(sisaHutang);
                    dataTransaksi.sisaHutang = sisaHutang;
                    updateStruk(true);
                }
                return;
            }
            
            dataTransaksi.kembalian = uangDibayar - totalBayar;
            updateStruk(false);
        }

        function updateStruk(isPartialPayment) {
            document.getElementById('tanggalTransaksi').textContent = 
                new Date().toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            
            document.getElementById('strukNama').textContent = dataTransaksi.namaPembeli;
            document.getElementById('strukBerat').textContent = `${dataTransaksi.beratTotal} kg`;
            document.getElementById('strukEkor').textContent = `${dataTransaksi.jumlahEkor}`;
            document.getElementById('strukHargaKg').textContent = formatRupiah(dataTransaksi.hargaPerKg);
            document.getElementById('strukSubtotal').textContent = formatRupiah(dataTransaksi.totalAyam);
            document.getElementById('strukTotal').textContent = formatRupiah(dataTransaksi.totalBayar);
            
            document.getElementById('strukBubutRow').style.display = dataTransaksi.perluBubut ? 'flex' : 'none';
            document.getElementById('strukBiayaBubut').textContent = dataTransaksi.perluBubut ? formatRupiah(dataTransaksi.biayaBubut) : 'Rp 0';
            
            document.getElementById('strukDibayarRow').style.display = 'flex';
            document.getElementById('strukDibayar').textContent = formatRupiah(dataTransaksi.uangDibayar);

            document.getElementById('strukSisaHutangRow').style.display = isPartialPayment ? 'flex' : 'none';
            document.getElementById('strukKembalianRow').style.display = !isPartialPayment ? 'flex' : 'none';
            
            document.getElementById('strukSisaHutang').textContent = isPartialPayment ? formatRupiah(dataTransaksi.sisaHutang) : 'Rp 0';
            document.getElementById('strukKembalian').textContent = !isPartialPayment ? formatRupiah(dataTransaksi.kembalian) : 'Rp 0';
            
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page3').classList.remove('hidden');
        }

        // Transaksi baru
        function transaksiBaru() {
            // Reset semua form
            document.getElementById('beratTotal').value = '';
            document.getElementById('jumlahEkor').value = '';
            document.getElementById('namaPembeli').value = '';
            document.getElementById('uangDibayar').value = '';
            document.querySelector('input[name="bubut"][value="tidak"]').checked = true;
            document.getElementById('hargaBubutContainer').classList.add('hidden');
            
            // Reset data
            dataTransaksi = {};
            
            // Hitung ulang
            hitungTotal();
            
            // Kembali ke halaman 1
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('page1').classList.remove('hidden');
        }

        // FUNGSI UTANG
        function simpanHutang(jumlahHutang = null) {
            const namaPembeli = document.getElementById('namaPembeli').value.trim();
            if (!namaPembeli) {
                alert('Mohon isi nama pembeli untuk menyimpan hutang!');
                return;
            }
            
            const totalHutang = jumlahHutang || dataTransaksi.totalBayar;
            const berat = dataTransaksi.beratTotal;
            const ekor = dataTransaksi.jumlahEkor;
            const tanggal = new Date().toISOString();

            if (db) {
                try {
                    db.run("INSERT INTO utang (nama, berat, ekor, total, tanggal) VALUES (?, ?, ?, ?, ?)", 
                        [namaPembeli, berat, ekor, totalHutang, tanggal]);
                    alert('Transaksi berhasil disimpan sebagai hutang!');
                    transaksiBaru();
                } catch (e) {
                    console.error("Failed to insert into database:", e);
                    alert("Gagal menyimpan hutang. Cek konsol untuk detail.");
                }
            } else {
                alert("Database tidak siap. Coba muat ulang halaman.");
            }
        }

        async function tampilHutang() {
            const daftarHutang = document.getElementById('daftarHutang');
            daftarHutang.innerHTML = ''; 
            
            let totalHutangKeseluruhan = 0;

            if (db) {
                const res = db.exec("SELECT * FROM utang ORDER BY tanggal DESC;");
                if (res.length > 0) {
                    const rows = res[0].values;
                    const cols = res[0].columns;
                    rows.forEach(row => {
                        const rowData = Object.fromEntries(cols.map((col, i) => [col, row[i]]));
                        totalHutangKeseluruhan += rowData.total;
                        const tanggalFormatted = new Date(rowData.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });

                        const hutangCard = document.createElement('div');
                        hutangCard.className = "bg-gray-50 rounded-xl p-4 shadow-sm border-l-4 border-red-400";
                        hutangCard.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-gray-800">${rowData.nama}</span>
                                <span class="text-sm text-gray-500">${tanggalFormatted}</span>
                            </div>
                            <div class="text-sm space-y-1">
                                <div class="flex justify-between">
                                    <span>Berat:</span>
                                    <span>${rowData.berat} kg</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Jumlah Ekor:</span>
                                    <span>${rowData.ekor} ekor</span>
                                </div>
                            </div>
                            <div class="flex justify-between font-bold text-red-600 mt-2">
                                <span>Total Hutang:</span>
                                <span>${formatRupiah(rowData.total)}</span>
                            </div>
                            <div class="flex space-x-2 mt-4">
                                <button onclick="bukaModalBayar(${rowData.id}, '${rowData.nama}', ${rowData.total})"
                                    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors">
                                    Bayar
                                </button>
                                <button onclick="hapusHutang(${rowData.id})"
                                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm transition-colors">
                                    Hapus
                                </button>
                            </div>
                        `;
                        daftarHutang.appendChild(hutangCard);
                    });
                } else {
                    daftarHutang.innerHTML = '<p class="text-center text-gray-500">Tidak ada hutang saat ini. üéâ</p>';
                }
            } else {
                daftarHutang.innerHTML = '<p class="text-center text-red-500">Gagal memuat database hutang.</p>';
            }

            document.getElementById('infoHutang').textContent = `Total hutang saat ini: ${formatRupiah(totalHutangKeseluruhan)}`;
        }

        function bukaModalBayar(id, nama, total) {
            idHutangAktif = id;
            document.getElementById('modalNamaHutang').textContent = nama;
            document.getElementById('modalTotalHutang').textContent = formatRupiah(total);
            document.getElementById('inputBayarHutang').value = '';
            document.getElementById('modalBayarHutang').classList.remove('hidden');
        }

        function tutupModal() {
            document.getElementById('modalBayarHutang').classList.add('hidden');
        }

        function prosesPembayaranHutang() {
            const jumlahBayar = parseFloat(document.getElementById('inputBayarHutang').value);
            if (isNaN(jumlahBayar) || jumlahBayar <= 0) {
                alert("Jumlah pembayaran tidak valid.");
                return;
            }

            if (db) {
                const res = db.exec(`SELECT total FROM utang WHERE id = ${idHutangAktif};`);
                if (res.length > 0) {
                    const totalLama = res[0].values[0][0];
                    const sisaHutang = totalLama - jumlahBayar;

                    if (sisaHutang <= 0) {
                        db.run(`DELETE FROM utang WHERE id = ${idHutangAktif}`);
                        alert('Hutang lunas!');
                        if (sisaHutang < 0) {
                            alert(`Ada kembalian sebesar ${formatRupiah(Math.abs(sisaHutang))}`);
                        }
                    } else {
                        db.run(`UPDATE utang SET total = ${sisaHutang} WHERE id = ${idHutangAktif}`);
                        alert(`Pembayaran berhasil. Sisa hutang: ${formatRupiah(sisaHutang)}`);
                    }
                    tutupModal();
                    tampilHutang(); // Perbarui tampilan
                }
            }
        }

        function hapusHutang(id) {
            if (confirm("Apakah Anda yakin ingin menghapus hutang ini?")) {
                if (db) {
                    db.run(`DELETE FROM utang WHERE id = ${id}`);
                    alert('Hutang berhasil dihapus.');
                    tampilHutang();
                }
            }
        }

        // FUNGSI BARU UNTUK MENGUNDUH STRUK
        function downloadStruk() {
            const strukElement = document.getElementById('struk');

            html2canvas(strukElement, { scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `struk-${dataTransaksi.namaPembeli.replace(/\s/g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        initDatabase();
        hitungTotal();

    </script>
</body>
                        </html>                    </div>
                </div>
            </div>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Berat Total (Kg)</label>
                    <input type="number" id="beratTotal" step="0.1" placeholder="0.0"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Ekor</label>
                    <input type="number" id="jumlahEkor" placeholder="0"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-lg">
                </div>
            </div>

            <div class="bg-gray-50 rounded-xl p-4 mb-6">
                <h3 class="font-semibold text-gray-700 mb-3">üí∞ Total Harga</h3>
                <div class="text-3xl font-bold text-orange-600" id="totalHarga">Rp 0</div>
                <div class="text-sm text-gray-600 mt-1" id="detailHarga">0 kg √ó Rp 0 = Rp 0</div>
            </div>

            <button onclick="lanjutKeHalaman2()" id="btnLanjut" disabled
                    class="w-full bg-orange-500 hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                Lanjut ke Pembayaran ‚Üí
            </button>
        </div>
        <div class="flex justify-center mt-4">
            <button onclick="lanjutKeHutang()" class="text-sm text-orange-600 hover:underline">
                Lihat Daftar Hutang ‚Üí
            </button>
        </div>
    </div>

    <div id="page2" class="container mx-auto px-4 py-8 max-w-md hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">üìù</div>
                <h1 class="text-2xl font-bold text-gray-800">Detail Pembeli</h1>
                <p class="text-gray-600 text-sm">Lengkapi informasi pembayaran</p>
            </div>

            <div class="bg-orange-50 rounded-xl p-4 mb-6">
                <h3 class="font-semibold text-gray-700 mb-2">üìã Ringkasan Pesanan</h3>
                <div class="text-sm space-y-1">
                    <div class="flex justify-between">
                        <span>Berat:</span>
                        <span id="ringkasanBerat">0 kg</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Jumlah Ekor:</span>
                        <span id="ringkasanEkor">0 ekor</span>
                    </div>
                    <div class="flex justify-between font-semibold text-orange-600">
                        <span>Total:</span>
                        <span id="ringkasanTotal">Rp 0</span>
                    </div>
                </div>
            </div>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pembeli</label>
                    <input type="text" id="namaPembeli" placeholder="Masukkan nama pembeli"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>

                <div class="bg-yellow-50 rounded-xl p-4">
                    <h3 class="font-semibold text-gray-700 mb-3">üî™ Layanan Bubut</h3>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="radio" name="bubut" value="tidak" checked
                                   class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                            <span class="ml-2 text-sm">Tidak perlu dibubut</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="bubut" value="ya"
                                   class="w-4 h-4 text-orange-600 focus:ring-orange-500">
                            <span class="ml-2 text-sm">Ya, bubut ayam</span>
                        </label>
                    </div>
                    
                    <div id="hargaBubutContainer" class="mt-3 hidden">
                        <label class="block text-sm font-medium text-gray-600 mb-1">Harga Bubut per Ekor</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                            <input type="number" id="hargaBubut" value="3000"
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-4">
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>Harga Ayam:</span>
                            <span id="hargaAyamFinal">Rp 0</span>
                        </div>
                        <div class="flex justify-between text-sm" id="hargaBubutRow" style="display: none;">
                            <span>Biaya Bubut:</span>
                            <span id="biayaBubut">Rp 0</span>
                        </div>
                        <hr class="my-2">
                        <div class="flex justify-between font-bold text-lg text-orange-600">
                            <span>Total Bayar:</span>
                            <span id="totalBayar">Rp 0</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Uang Dibayarkan</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                        <input type="number" id="uangDibayar" placeholder="0"
                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-lg">
                    </div>
                </div>

                <div class="bg-green-50 rounded-xl p-4" id="kembalianContainer" style="display: none;">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-700">üíµ Kembalian:</span>
                        <span class="text-xl font-bold text-green-600" id="kembalian">Rp 0</span>
                    </div>
                </div>
            </div>

            <div class="flex space-x-3 mt-4">
                <button onclick="kembaliKeHalaman1()"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    ‚Üê Kembali
                </button>
                <button onclick="selesaikanTransaksi()" id="btnSelesai"
                        class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    Selesai
                </button>
            </div>
            <button onclick="simpanHutang()" id="btnHutang"
                    class="w-full mt-3 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    Simpan sebagai Hutang
            </button>
        </div>
    </div>

    <div id="page3" class="container mx-auto px-4 py-8 max-w-md hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">‚úÖ</div>
                <h1 class="text-2xl font-bold text-gray-800">Transaksi Selesai</h1>
                <p class="text-gray-600 text-sm">Terima kasih atas pembeliannya!</p>
            </div>

            <div class="bg-gray-50 rounded-xl p-6 mb-6" id="struk">
                <div class="text-center mb-4">
                    <h2 class="text-lg font-bold">üêî MyChicken </h2>
                    <p class="text-sm text-gray-600" id="tanggalTransaksi"></p>
                </div>
                
                <hr class="my-4">
                
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Nama Pembeli:</span>
                        <span id="strukNama">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Berat Ayam:</span>
                        <span id="strukBerat">0 kg</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Jumlah Ekor:</span>
                        <span id="strukEkor">0 ekor</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Harga per Kg:</span>
                        <span id="strukHargaKg">Rp 0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Subtotal Ayam:</span>
                        <span id="strukSubtotal">Rp 0</span>
                    </div>
                    <div class="flex justify-between" id="strukBubutRow" style="display: none;">
                        <span>Biaya Bubut:</span>
                        <span id="strukBiayaBubut">Rp 0</span>
                    </div>
                    
                    <hr class="my-2">
                    
                    <div class="flex justify-between font-bold">
                        <span>Total Bayar:</span>
                        <span id="strukTotal">Rp 0</span>
                    </div>
                    
                    <div class="flex justify-between" id="strukDibayarRow">
                        <span>Uang Dibayar:</span>
                        <span id="strukDibayar">Rp 0</span>
                    </div>
                    <div class="flex justify-between font-semibold text-red-600" id="strukSisaHutangRow" style="display: none;">
                        <span>Sisa Hutang:</span>
                        <span id="strukSisaHutang">Rp 0</span>
                    </div>
                    <div class="flex justify-between font-semibold text-green-600" id="strukKembalianRow" style="display: none;">
                        <span>Kembalian:</span>
                        <span id="strukKembalian">Rp 0</span>
                    </div>
                </div>
            </div>

            <button onclick="transaksiBaru()"
                    class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                üîÑ Transaksi Baru
            </button>
        </div>
    </div>

    <div id="page4" class="container mx-auto px-4 py-8 max-w-md hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <div class="text-center mb-6">
                <div class="text-4xl mb-2">üí∏</div>
                <h1 class="text-2xl font-bold text-gray-800">Daftar Hutang</h1>
                <p class="text-gray-600 text-sm" id="infoHutang"></p>
            </div>
            
            <div id="daftarHutang" class="space-y-4">
                </div>
            
            <button onclick="kembaliKeHalaman1()"
                    class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                ‚Üê Kembali ke Beranda
            </button>
        </div>
    </div>

    <div id="modalBayarHutang" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Pembayaran Hutang</h2>
            <div class="mb-4">
                <p class="text-sm text-gray-600">Nama: <span id="modalNamaHutang" class="font-semibold"></span></p>
                <p class="text-sm text-gray-600">Total Hutang: <span id="modalTotalHutang" class="font-semibold text-red-600"></span></p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Pembayaran</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">Rp</span>
                    <input type="number" id="inputBayarHutang" placeholder="0"
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg">
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="tutupModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Batal</button>
                <button onclick="prosesPembayaranHutang()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Bayar</button>
            </div>
        </div>
    </div>

    <script>
        let dataTransaksi = {};
        let db = null;
        let idHutangAktif = null;

        // Inisialisasi Database
        async function initDatabase() {
            try {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                db = new SQL.Database();
                db.run("CREATE TABLE IF NOT EXISTS utang (id INTEGER PRIMARY KEY AUTOINCREMENT, nama TEXT, berat REAL, ekor INTEGER, total REAL, tanggal TEXT);");
                console.log("Database initialized successfully.");
            } catch (err) {
                console.error("Failed to initialize database:", err);
            }
        }

        // Format rupiah
        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(angka);
        }

        // Hitung total harga di halaman 1
        function hitungTotal() {
            const hargaPerKg = parseFloat(document.getElementById('hargaPerKg').value) || 0;
            const beratTotal = parseFloat(document.getElementById('beratTotal').value) || 0;
            const jumlahEkor = parseInt(document.getElementById('jumlahEkor').value) || 0;
            
            const total = hargaPerKg * beratTotal;
            
            document.getElementById('totalHarga').textContent = formatRupiah(total);
            document.getElementById('detailHarga').textContent = 
                `${beratTotal} kg √ó ${formatRupiah(hargaPerKg)} = ${formatRupiah(total)}`;
            
            // Enable/disable tombol lanjut
            const btnLanjut = document.getElementById('btnLanjut');
            if (beratTotal > 0 && jumlahEkor > 0) {
                btnLanjut.disabled = false;
            } else {
                btnLanjut.disabled = true;
            }
        }

        // Event listeners untuk halaman 1
        document.getElementById('hargaPerKg').addEventListener('input', hitungTotal);
        document.getElementById('beratTotal').addEventListener('input', hitungTotal);
        document.getElementById('jumlahEkor').addEventListener('input', hitungTotal);

        // Lanjut ke halaman 2
        function lanjutKeHalaman2() {
            dataTransaksi.hargaPerKg = parseFloat(document.getElementById('hargaPerKg').value);
            dataTransaksi.beratTotal = parseFloat(document.getElementById('beratTotal').value);
            dataTransaksi.jumlahEkor = parseInt(document.getElementById('jumlahEkor').value);
            dataTransaksi.totalAyam = dataTransaksi.hargaPerKg * dataTransaksi.beratTotal;
            
            // Update ringkasan
            document.getElementById('ringkasanBerat').textContent = `${dataTransaksi.beratTotal} kg`;
            document.getElementById('ringkasanEkor').textContent = `${dataTransaksi.jumlahEkor} ekor`;
            document.getElementById('ringkasanTotal').textContent = formatRupiah(dataTransaksi.totalAyam);
            document.getElementById('hargaAyamFinal').textContent = formatRupiah(dataTransaksi.totalAyam);
            
            hitungTotalAkhir();
            
            document.getElementById('page1').classList.add('hidden');
            document.getElementById('page2').classList.remove('hidden');
        }

        // Handle radio button bubut
        document.querySelectorAll('input[name="bubut"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const hargaBubutContainer = document.getElementById('hargaBubutContainer');
                if (this.value === 'ya') {
                    hargaBubutContainer.classList.remove('hidden');
                } else {
                    hargaBubutContainer.classList.add('hidden');
                }
                hitungTotalAkhir();
            });
        });

        // Hitung total akhir di halaman 2
        function hitungTotalAkhir() {
            const perluBubut = document.querySelector('input[name="bubut"]:checked').value === 'ya';
            const hargaBubut = parseFloat(document.getElementById('hargaBubut').value) || 0;
            
            let biayaBubut = 0;
            if (perluBubut) {
                biayaBubut = hargaBubut * dataTransaksi.jumlahEkor;
                document.getElementById('hargaBubutRow').style.display = 'flex';
                document.getElementById('biayaBubut').textContent = formatRupiah(biayaBubut);
            } else {
                document.getElementById('hargaBubutRow').style.display = 'none';
            }
            
            const totalBayar = dataTransaksi.totalAyam + biayaBubut;
            document.getElementById('totalBayar').textContent = formatRupiah(totalBayar);
            
            dataTransaksi.biayaBubut = biayaBubut;
            dataTransaksi.totalBayar = totalBayar;
            dataTransaksi.perluBubut = perluBubut;
            
            hitungKembalian();
        }

        // Hitung kembalian
        function hitungKembalian() {
            const uangDibayar = parseFloat(document.getElementById('uangDibayar').value) || 0;
            const kembalian = uangDibayar - dataTransaksi.totalBayar;
            
            if (uangDibayar > 0) {
                document.getElementById('kembalianContainer').style.display = 'block';
                if (kembalian >= 0) {
                    document.getElementById('kembalian').textContent = formatRupiah(kembalian);
                    document.getElementById('kembalian').className = 'text-xl font-bold text-green-600';
                } else {
                    document.getElementById('kembalian').textContent = formatRupiah(Math.abs(kembalian)) + ' (kurang)';
                    document.getElementById('kembalian').className = 'text-xl font-bold text-red-600';
                }
            } else {
                document.getElementById('kembalianContainer').style.display = 'none';
            }
            
            dataTransaksi.uangDibayar = uangDibayar;
            dataTransaksi.kembalian = kembalian;
        }

        // Event listeners untuk halaman 2
        document.getElementById('hargaBubut').addEventListener('input', hitungTotalAkhir);
        document.getElementById('uangDibayar').addEventListener('input', hitungKembalian);

        // Kembali ke halaman 1
        function kembaliKeHalaman1() {
            document.getElementById('page2').classList.add('hidden');
            document.getElementById('page3').classList.add('hidden');
            document.getElementById('page4').classList.add('hidden');
            document.getElementById('page1').classList.remove('hidden');
        }

        // Lanjut ke halaman hutang
        async function lanjutKeHutang() {
            document.getElementById('page1').classList.add('hidden');
            document.getElementById('page2').classList.add('hidden');
            document.getElementById('page3').classList.add('hidden');
            document.getElementById('page4').classList.remove('hidden');
            await tampilHutang();
        }

        // Selesaikan transaksi
        function selesaikanTransaksi() {
            const namaPembeli = document.getElementById('namaPembeli').value.trim();
            const uangDibayar = parseFloat(document.getElementById('uangDibayar').value) || 0;
            const totalBayar = dataTransaksi.totalBayar;
            
            if (!namaPembeli) {
                alert('Mohon isi nama pembeli!');
                return;
            }

            if (uangDibayar < totalBayar) {
                const sisaHutang = totalBayar - uangDibayar;
                if (confirm(`Uang yang dibayarkan kurang. Apakah Anda ingin menyimpan sisa ${formatRupiah(sisaHutang)} sebagai hutang?`)) {
                    simpanHutang(sisaHutang);
                    dataTransaksi.uangDibayar = uangDibayar;
                    dataTransaksi.sisaHutang = sisaHutang;
                    updateStruk(true);
                }
                return;
            }
            
            dataTransaksi.namaPembeli = namaPembeli;
            dataTransaksi.uangDibayar = uangDibayar;
            dataTransaksi.kembalian = uangDibayar - totalBayar;
            
            updateStruk(false);
        }

        function updateStruk(isPartialPayment) {
            document.getElementById('tanggalTransaksi').textContent = 
                new Date().toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            
            document.getElementById('strukNama').textContent = dataTransaksi.namaPembeli;
            document.getElementById('strukBerat').textContent = `${dataTransaksi.beratTotal} kg`;
            document.getElementById('strukEkor').textContent = `${dataTransaksi.jumlahEkor} ekor`;
            document.getElementById('strukHargaKg').textContent = formatRupiah(dataTransaksi.hargaPerKg);
            document.getElementById('strukSubtotal').textContent = formatRupiah(dataTransaksi.totalAyam);
            document.getElementById('strukTotal').textContent = formatRupiah(dataTransaksi.totalBayar);
            
            if (dataTransaksi.perluBubut) {
                document.getElementById('strukBubutRow').style.display = 'flex';
                document.getElementById('strukBiayaBubut').textContent = formatRupiah(dataTransaksi.biayaBubut);
            }
            
            document.getElementById('strukDibayarRow').style.display = 'flex';
            document.getElementById('strukDibayar').textContent = formatRupiah(dataTransaksi.uangDibayar);

            if (isPartialPayment) {
                document.getElementById('strukSisaHutangRow').style.display = 'flex';
                document.getElementById('strukSisaHutang').textContent = formatRupiah(dataTransaksi.sisaHutang);
                document.getElementById('strukKembalianRow').style.display = 'none';
            } else {
                document.getElementById('strukKembalianRow').style.display = 'flex';
                document.getElementById('strukKembalian').textContent = formatRupiah(dataTransaksi.kembalian);
                document.getElementById('strukSisaHutangRow').style.display = 'none';
            }

            document.getElementById('page2').classList.add('hidden');
            document.getElementById('page3').classList.remove('hidden');
        }

        // Transaksi baru
        function transaksiBaru() {
            // Reset semua form
            document.getElementById('beratTotal').value = '';
            document.getElementById('jumlahEkor').value = '';
            document.getElementById('namaPembeli').value = '';
            document.getElementById('uangDibayar').value = '';
            document.querySelector('input[name="bubut"][value="tidak"]').checked = true;
            document.getElementById('hargaBubutContainer').classList.add('hidden');
            
            // Reset data
            dataTransaksi = {};
            
            // Hitung ulang
            hitungTotal();
            
            // Kembali ke halaman 1
            document.getElementById('page3').classList.add('hidden');
            document.getElementById('page1').classList.remove('hidden');
        }

        // FUNGSI UTANG
        function simpanHutang(jumlahHutang = null) {
            const namaPembeli = document.getElementById('namaPembeli').value.trim();
            if (!namaPembeli) {
                alert('Mohon isi nama pembeli untuk menyimpan hutang!');
                return;
            }
            
            const totalHutang = jumlahHutang || dataTransaksi.totalBayar;
            const berat = dataTransaksi.beratTotal;
            const ekor = dataTransaksi.jumlahEkor;
            const tanggal = new Date().toISOString();

            if (db) {
                try {
                    db.run("INSERT INTO utang (nama, berat, ekor, total, tanggal) VALUES (?, ?, ?, ?, ?)", 
                        [namaPembeli, berat, ekor, totalHutang, tanggal]);
                    alert('Transaksi berhasil disimpan sebagai hutang!');
                    transaksiBaru();
                } catch (e) {
                    console.error("Failed to insert into database:", e);
                    alert("Gagal menyimpan hutang. Cek konsol untuk detail.");
                }
            } else {
                alert("Database tidak siap. Coba muat ulang halaman.");
            }
        }

        async function tampilHutang() {
            const daftarHutang = document.getElementById('daftarHutang');
            daftarHutang.innerHTML = ''; // Kosongkan daftar
            
            let totalHutangKeseluruhan = 0;

            if (db) {
                const res = db.exec("SELECT * FROM utang ORDER BY tanggal DESC;");
                if (res.length > 0) {
                    const rows = res[0].values;
                    const cols = res[0].columns;
                    rows.forEach(row => {
                        const rowData = Object.fromEntries(cols.map((col, i) => [col, row[i]]));
                        totalHutangKeseluruhan += rowData.total;
                        const tanggalFormatted = new Date(rowData.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });

                        const hutangCard = document.createElement('div');
                        hutangCard.className = "bg-gray-50 rounded-xl p-4 shadow-sm";
                        hutangCard.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-gray-800">${rowData.nama}</span>
                                <span class="text-sm text-gray-500">${tanggalFormatted}</span>
                            </div>
                            <div class="text-sm space-y-1">
                                <div class="flex justify-between">
                                    <span>Berat:</span>
                                    <span>${rowData.berat} kg</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Jumlah Ekor:</span>
                                    <span>${rowData.ekor} ekor</span>
                                </div>
                            </div>
                            <div class="flex justify-between font-bold text-red-600 mt-2">
                                <span>Total Hutang:</span>
                                <span>${formatRupiah(rowData.total)}</span>
                            </div>
                            <div class="flex space-x-2 mt-4">
                                <button onclick="bukaModalBayar(${rowData.id}, '${rowData.nama}', ${rowData.total})"
                                    class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                                    Bayar
                                </button>
                                <button onclick="hapusHutang(${rowData.id})"
                                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm">
                                    Hapus
                                </button>
                            </div>
                        `;
                        daftarHutang.appendChild(hutangCard);
                    });
                } else {
                    daftarHutang.innerHTML = '<p class="text-center text-gray-500">Tidak ada hutang saat ini. üéâ</p>';
                }
            } else {
                daftarHutang.innerHTML = '<p class="text-center text-red-500">Gagal memuat database hutang.</p>';
            }

            document.getElementById('infoHutang').textContent = `Total hutang saat ini: ${formatRupiah(totalHutangKeseluruhan)}`;
        }

        function bukaModalBayar(id, nama, total) {
            idHutangAktif = id;
            document.getElementById('modalNamaHutang').textContent = nama;
            document.getElementById('modalTotalHutang').textContent = formatRupiah(total);
            document.getElementById('inputBayarHutang').value = '';
            document.getElementById('modalBayarHutang').classList.remove('hidden');
        }

        function tutupModal() {
            document.getElementById('modalBayarHutang').classList.add('hidden');
        }

        function prosesPembayaranHutang() {
            const jumlahBayar = parseFloat(document.getElementById('inputBayarHutang').value);
            if (isNaN(jumlahBayar) || jumlahBayar <= 0) {
                alert("Jumlah pembayaran tidak valid.");
                return;
            }

            if (db) {
                const res = db.exec(`SELECT total FROM utang WHERE id = ${idHutangAktif};`);
                if (res.length > 0) {
                    const totalLama = res[0].values[0][0];
                    const sisaHutang = totalLama - jumlahBayar;

                    if (sisaHutang <= 0) {
                        db.run(`DELETE FROM utang WHERE id = ${idHutangAktif}`);
                        alert('Hutang lunas!');
                    } else {
                        db.run(`UPDATE utang SET total = ${sisaHutang} WHERE id = ${idHutangAktif}`);
                        alert(`Pembayaran berhasil. Sisa hutang: ${formatRupiah(sisaHutang)}`);
                    }
                    tutupModal();
                    tampilHutang(); // Perbarui tampilan
                }
            }
        }

        function hapusHutang(id) {
            if (confirm("Apakah Anda yakin ingin menghapus hutang ini?")) {
                if (db) {
                    db.run(`DELETE FROM utang WHERE id = ${id}`);
                    alert('Hutang berhasil dihapus.');
                    tampilHutang();
                }
            }
        }
        
        // Panggil fungsi inisialisasi saat halaman dimuat
        initDatabase();
        hitungTotal();

    </script>
</body>
</html>
